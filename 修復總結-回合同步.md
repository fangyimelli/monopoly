# å›åˆåŒæ­¥å•é¡Œä¿®å¾©ç¸½çµ

## ğŸ” å•é¡Œåˆ†æ

### ç—‡ç‹€
- èµ°åˆ°åˆ¥äººåœ°ç›¤ä¸¦ã€Œæ‹’çµ•å¹«å¿™ã€å¾Œï¼Œå…©å€‹ç©å®¶çœ‹åˆ°ä¸åŒçš„ç•¶å‰ç©å®¶
- ç©å®¶ A çœ‹åˆ°ç•¶å‰ç©å®¶æ˜¯ B
- ç©å®¶ B çœ‹åˆ°ç•¶å‰ç©å®¶æ˜¯ A
- æŒ‰éˆ•ç‹€æ…‹æ­£ç¢ºï¼ˆç¦ç”¨ï¼‰ï¼Œä½†ç¸½æ˜¯é¡¯ç¤ºã€Œé‚„æ²’è¼ªåˆ°æˆ‘ã€

### æ ¹æœ¬åŸå› 
**ç‹€æ…‹äº‹ä»¶æ™‚åºå•é¡Œ**ï¼š

```
æ™‚é–“ç·šï¼š
T0: ç©å®¶é»æ“Šã€Œæ‹’çµ•å¹«å¿™ã€
T1: æœå‹™å™¨ç™¼é€ playerPenalized (åŒ…å«èˆŠ gameStateï¼Œå›åˆæœªçµæŸ)
T2: å®¢æˆ¶ç«¯æ›´æ–° gameState â† èˆŠç‹€æ…‹ï¼ˆç•¶å‰ç©å®¶æ˜¯ Aï¼‰
T3: 500ms å¾Œï¼Œæœå‹™å™¨ç™¼é€ turnEnded (åŒ…å«æ–° gameStateï¼Œå›åˆå·²çµæŸ)
T4: å®¢æˆ¶ç«¯æ›´æ–° gameState â† æ–°ç‹€æ…‹ï¼ˆç•¶å‰ç©å®¶æ˜¯ Bï¼‰

å•é¡Œï¼šå¦‚æœ T1 å’Œ T3 çš„äº‹ä»¶åˆ°é”æ™‚åºä¸ä¸€è‡´ï¼Œæˆ–è¢«å…¶ä»–æ“ä½œæ‰“æ–·ï¼Œ
æœƒå°è‡´ä¸åŒå®¢æˆ¶ç«¯çœ‹åˆ°ä¸åŒç‰ˆæœ¬çš„ gameStateï¼
```

## âœ… ä¿®å¾©æ–¹æ¡ˆ

### æ ¸å¿ƒæ€æƒ³
**åˆ†é›¢é‡‘éŒ¢æ›´æ–°å’Œå›åˆç‹€æ…‹æ›´æ–°**ï¼Œç¢ºä¿åªæœ‰ä¸€å€‹çœŸå¯¦ä¾†æºï¼ˆturnEndedï¼‰æ§åˆ¶å›åˆç‹€æ…‹ã€‚

### ä¿®å¾©å…§å®¹

#### 1. æœå‹™å™¨ç«¯ (server.js)

**ä¿®æ”¹å‰**ï¼š
```javascript
io.to(roomCode).emit('playerPenalized', {
    playerId: socket.id,
    penalty: penalty,
    ownerId: owner ? owner.id : null,
    gameState: game.getGameState()  // âŒ åŒ…å«å®Œæ•´ç‹€æ…‹
});
```

**ä¿®æ”¹å¾Œ**ï¼š
```javascript
io.to(roomCode).emit('playerPenalized', {
    playerId: socket.id,
    penalty: penalty,
    newBalance: player.money,
    ownerId: owner ? owner.id : null,
    ownerNewBalance: owner ? owner.money : undefined,
    publicFund: game.publicFund
    // âœ… åªç™¼é€é‡‘éŒ¢è®ŠåŒ–ï¼Œä¸ç™¼é€ gameState
});
```

#### 2. å®¢æˆ¶ç«¯ (game.js)

**ä¿®æ”¹å‰**ï¼š
```javascript
this.socket.on('playerPenalized', (data) => {
    this.gameState = data.gameState;  // âŒ è¦†è“‹æ•´å€‹ç‹€æ…‹
    this.updateGameScreen();
});
```

**ä¿®æ”¹å¾Œ**ï¼š
```javascript
this.socket.on('playerPenalized', (data) => {
    // âœ… åªæ›´æ–°é‡‘éŒ¢ï¼Œä¸æ”¹è®Šå›åˆç‹€æ…‹
    const penalizedPlayer = this.gameState.players.find(p => p.id === data.playerId);
    if (penalizedPlayer && data.newBalance !== undefined) {
        penalizedPlayer.money = data.newBalance;
    }
    
    if (data.ownerId && data.ownerNewBalance !== undefined) {
        const ownerPlayer = this.gameState.players.find(p => p.id === data.ownerId);
        if (ownerPlayer) {
            ownerPlayer.money = data.ownerNewBalance;
        }
    }
    
    if (data.publicFund !== undefined) {
        this.gameState.publicFund = data.publicFund;
    }
    
    this.updateGameScreen();
});
```

## ğŸ“Š ä¿®å¾©æ•ˆæœ

### ä¿®å¾©å‰çš„äº‹ä»¶æµ
```
ç©å®¶ A é»æ“Šã€Œæ‹’çµ•å¹«å¿™ã€
  â†“
playerPenalized (gameState: currentPlayer = A, index = 0)
  â†“
å®¢æˆ¶ç«¯ A: currentPlayer = A â† éŒ¯èª¤ï¼æ‡‰è©²æ˜¯ B
å®¢æˆ¶ç«¯ B: currentPlayer = B â† éŒ¯èª¤ï¼æ‡‰è©²æ˜¯ B
  â†“
500ms å¾Œ turnEnded (gameState: currentPlayer = B, index = 1)
  â†“
å®¢æˆ¶ç«¯ A: currentPlayer = B â† æ­£ç¢º
å®¢æˆ¶ç«¯ B: currentPlayer = A â† é‚„æ˜¯éŒ¯èª¤ï¼äº‹ä»¶é †åºæ··äº‚
```

### ä¿®å¾©å¾Œçš„äº‹ä»¶æµ
```
ç©å®¶ A é»æ“Šã€Œæ‹’çµ•å¹«å¿™ã€
  â†“
playerPenalized (åªæœ‰é‡‘éŒ¢è®ŠåŒ–)
  â†“
å®¢æˆ¶ç«¯æ›´æ–°é‡‘éŒ¢ï¼Œå›åˆç‹€æ…‹ä¸è®Š
  â†“
500ms å¾Œ turnEnded (gameState: currentPlayer = B, index = 1)
  â†“
æ‰€æœ‰å®¢æˆ¶ç«¯: currentPlayer = B â† ä¸€è‡´ï¼
```

## ğŸ§ª æ¸¬è©¦æ­¥é©Ÿ

1. **é‡æ–°å•Ÿå‹•æœå‹™å™¨**
   ```bash
   node server.js
   ```

2. **æ¸¬è©¦å ´æ™¯**
   - å‰µå»ºæˆ¿é–“ï¼Œè‡³å°‘ 2 å€‹ç©å®¶
   - ç©å®¶ A æ“²éª°å­ï¼Œèµ°åˆ°ç©å®¶ B çš„åœ°ç›¤
   - ç©å®¶ A é»æ“Šã€Œæ‹’çµ•å¹«å¿™ã€
   - ç¢ºèªå›åˆåˆ‡æ›åˆ°ç©å®¶ B
   - **åœ¨ç©å®¶ B çš„ç€è¦½å™¨**ï¼šæª¢æŸ¥æ˜¯å¦é¡¯ç¤ºã€Œè¼ªåˆ°æ‚¨äº†ã€
   - **åœ¨ç©å®¶ A çš„ç€è¦½å™¨**ï¼šæª¢æŸ¥æ˜¯å¦é¡¯ç¤ºã€Œé‚„æ²’è¼ªåˆ°æ‚¨ã€

3. **é æœŸçµæœ**
   - âœ… ç©å®¶ B å¯ä»¥æ“²éª°å­
   - âœ… ç©å®¶ A æŒ‰éˆ•è¢«ç¦ç”¨
   - âœ… å…©å€‹ç©å®¶éƒ½çœ‹åˆ°ç›¸åŒçš„ç•¶å‰ç©å®¶ï¼ˆBï¼‰
   - âœ… æ§åˆ¶å°æ—¥èªŒä¸­ `currentPlayer` å’Œ `currentPlayerIndex` ä¸€è‡´

## ğŸ“ ç›¸é—œä¿®æ”¹

1. **server.js** (2 è™•)
   - `handleOthersTag` äº‹ä»¶ï¼šä¿®æ”¹ `playerPenalized` ç™¼é€å…§å®¹
   - `handleOthersTagWithQuestion` äº‹ä»¶ï¼šä¿®æ”¹ `playerPenalized` ç™¼é€å…§å®¹

2. **public/js/game.js** (1 è™•)
   - `socket.on('playerPenalized')` äº‹ä»¶è™•ç†ï¼šåªæ›´æ–°é‡‘éŒ¢ï¼Œä¸è¦†è“‹ gameState

3. **server.js** (2 è™•) - ä¹‹å‰çš„ä¿®å¾©
   - æœå‹™å™¨è‡ªå‹•çµæŸå›åˆï¼ˆ500ms å»¶é²ï¼‰
   
4. **public/js/game.js** (2 è™•) - ä¹‹å‰çš„ä¿®å¾©
   - ç§»é™¤å‰ç«¯æ‰‹å‹• `endTurn()` èª¿ç”¨

## ğŸ¯ æ ¸å¿ƒåŸå‰‡

**å–®ä¸€çœŸå¯¦ä¾†æºï¼ˆSingle Source of Truthï¼‰**ï¼š
- `turnEnded` äº‹ä»¶ = å”¯ä¸€æ§åˆ¶å›åˆç‹€æ…‹çš„äº‹ä»¶
- å…¶ä»–äº‹ä»¶ï¼ˆå¦‚ `playerPenalized`ï¼‰= åªæ›´æ–°å±€éƒ¨ç‹€æ…‹ï¼ˆé‡‘éŒ¢ã€æ¨™ç±¤ç­‰ï¼‰
- é¿å…å¤šå€‹äº‹ä»¶ç«¶çˆ­ä¿®æ”¹åŒä¸€ç‹€æ…‹

é€™ç¢ºä¿äº†æ‰€æœ‰å®¢æˆ¶ç«¯å§‹çµ‚çœ‹åˆ°ä¸€è‡´çš„éŠæˆ²ç‹€æ…‹ï¼

